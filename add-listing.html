<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Add New Listing | Rageo Rentals</title>

  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: #f5f6fa;
      margin: 0;
      padding: 0;
      color: #333;
    }

    header {
      background: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 25px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    header img { height: 55px; }

    .user-info { font-size: 0.9em; color: #555; }
    .logout-btn {
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 6px 10px;
      cursor: pointer;
    }

    .hero {
      background: linear-gradient(rgba(0,0,0,0.35), rgba(0,0,0,0.35)), url('hero1.jpg') center/cover no-repeat;
      color: white;
      text-align: center;
      padding: 48px 20px;
    }

    form {
      max-width: 600px;
      margin: 0 auto 40px;
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    input, textarea, button {
      width: 100%;
      margin-top: 12px;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1em;
    }

    #preview img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      margin: 5px;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    button {
      background: #28a745;
      color: white;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover { background: #218838; }

    .share-box {
      display: none;
      margin-top: 12px;
      background: #eef9ee;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #d4f0d4;
    }

    footer {
      text-align: center;
      background: #f2f2f2;
      padding: 15px;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;gap:10px;">
      <img src="logo.jpg" alt="Rageo Rentals Logo">
      <h1 style="font-size:1.4em;margin:0;">Rageo Rentals</h1>
    </div>
    <div class="user-info" id="userInfo"></div>
  </header>

  <section class="hero">
    <h2>List Your Property Easily</h2>
    <p>Upload details and preview your images before posting</p>
  </section>

  <form id="listingForm" novalidate>
    <input type="text" id="title" placeholder="ðŸ  Property Title" required>
    <input type="text" id="location" placeholder="ðŸ“ Location (e.g. Kilimani, Nairobi)" required>
    <input type="text" id="price" placeholder="ðŸ’° Price (e.g. 65,000 KES/month)" required>
    <textarea id="description" placeholder="ðŸ“ Property Description (no phone numbers)" rows="4" required></textarea>
    <label style="margin-top:10px; font-weight:bold;">Upload images (you can select multiple)</label>
    <input type="file" id="images" accept="image/*" multiple required>
    <div id="preview" aria-live="polite"></div>
    <button type="submit">âž• Upload Listing</button>

    <div id="shareBox" class="share-box" aria-hidden="true">
      <div style="margin-bottom:6px;font-weight:bold;">Listing published â€” share this link:</div>
      <input id="shareLink" readonly>
      <button id="copyBtn" type="button">Copy</button>
      <button id="openBtn" type="button" style="background:#007bff; margin-left:8px;">Open</button>
    </div>
  </form>

  <footer>
    <p>Â© 2025 Rageo Properties. All rights reserved.</p>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, updateDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOoGvZDvzp-CHLVllJAujTdo84vxcz_hM",
      authDomain: "rageo-rentals.firebaseapp.com",
      projectId: "rageo-rentals",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const userInfo = document.getElementById("userInfo");
    const form = document.getElementById("listingForm");
    const imageInput = document.getElementById("images");
    const previewDiv = document.getElementById("preview");
    const shareBox = document.getElementById("shareBox");
    const shareLinkInput = document.getElementById("shareLink");
    const copyBtn = document.getElementById("copyBtn");
    const openBtn = document.getElementById("openBtn");

    const cloudName = "dx4akb9b0";
    const uploadPreset = "rageo_unsigned";

    // Redirect unauthenticated users
    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        userInfo.innerHTML = `
          Signed in as <strong>${user.email}</strong> 
          <button class="logout-btn" id="logoutBtn">Logout</button>`;
        document.getElementById("logoutBtn").onclick = () => {
          signOut(auth).then(() => window.location.href = "login.html");
        };
      }
    });

 let selectedFiles = [];

imageInput.addEventListener("change", () => {
  previewDiv.innerHTML = "";
  selectedFiles = [...imageInput.files];

  renderPreview();
});

function renderPreview() {
  previewDiv.innerHTML = "";

  selectedFiles.forEach((file, index) => {
    const reader = new FileReader();

    reader.onload = (e) => {
      const img = document.createElement("img");
      img.src = e.target.result;
      img.draggable = true;
      img.dataset.index = index;
      img.style.cursor = "grab";

      // Drag start
      img.addEventListener("dragstart", (ev) => {
        ev.dataTransfer.setData("text/plain", index);
      });

      // Drag over
      img.addEventListener("dragover", (ev) => {
        ev.preventDefault();
      });

      // Drop
      img.addEventListener("drop", (ev) => {
        ev.preventDefault();
        const fromIndex = parseInt(ev.dataTransfer.getData("text/plain"));
        const toIndex = parseInt(img.dataset.index);

        const moved = selectedFiles.splice(fromIndex, 1)[0];
        selectedFiles.splice(toIndex, 0, moved);

        renderPreview();
      });

      previewDiv.appendChild(img);
    };

    reader.readAsDataURL(file);
  });
});

    // Submission
    let isSubmitting = false;
    const sleep = ms => new Promise(r => setTimeout(r, ms));

    form.addEventListener("submit", async e => {
      e.preventDefault();
      if (isSubmitting) return;
      isSubmitting = true;

      const user = auth.currentUser;
      if (!user) {
        alert("Please log in first.");
        window.location.href = "login.html";
        return;
      }

      const title = document.getElementById("title").value.trim();
      const location = document.getElementById("location").value.trim();
      const price = document.getElementById("price").value.trim();
      const description = document.getElementById("description").value.trim();
      const files = selectedFiles;

      if (!title || !location || !price || files.length === 0) {
        alert("Complete all required fields and upload images.");
        isSubmitting = false;
        return;
      }

      const phonePattern = /\+?\d{3,}/g;
      if (phonePattern.test(description)) {
        alert("âŒ Please do not include phone numbers in the description.");
        isSubmitting = false;
        return;
      }

      try {
        const submitBtn = form.querySelector('button[type="submit"]');
        const prevText = submitBtn.textContent;
        submitBtn.textContent = "Uploading images...";

        const imageUrls = [];
        for (const f of files) {
          const fd = new FormData();
          fd.append("file", f);
          fd.append("upload_preset", uploadPreset);
          const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, { method:"POST", body:fd });
          const data = await res.json();
          imageUrls.push(data.secure_url);
          await sleep(120);
        }

        submitBtn.textContent = "Saving listing...";
        const docRef = await addDoc(collection(db, "listings"), {
          title, location, price, description,
          images: imageUrls, created: new Date(), user: user.email
        });

        const shareUrl = `${window.location.origin}/property.html?id=${docRef.id}`;
        shareLinkInput.value = shareUrl;
        shareBox.style.display = "block";
        alert("âœ… Listing added successfully!");
        form.reset(); previewDiv.innerHTML = "";
        submitBtn.textContent = prevText;
        setTimeout(() => window.location.href = "index.html", 6000);

      } catch (err) {
        console.error(err);
        alert("Error adding listing. Try again.");
      } finally {
        isSubmitting = false;
      }
    });
  </script>
</body>
</html>













